---
// Admin Chat Logs Page - View all chatbot conversations
import MainLayout from "../../layouts/MainLayout.astro";

const chatApiUrl =
  typeof import.meta.env.PUBLIC_CHATBOT_API_URL === "string"
    ? import.meta.env.PUBLIC_CHATBOT_API_URL.trim()
    : "";

const configuredConversationsUrl =
  typeof import.meta.env.PUBLIC_CHATBOT_CONVERSATIONS_URL === "string"
    ? import.meta.env.PUBLIC_CHATBOT_CONVERSATIONS_URL.trim()
    : "";

const conversationsApiUrl = configuredConversationsUrl
  ? configuredConversationsUrl
  : chatApiUrl && /\/chat\/?$/.test(chatApiUrl)
  ? chatApiUrl.replace(/\/chat\/?$/, "/conversations")
  : "";
---

<script is:inline define:vars={{ conversationsApiUrl }}>
  /**
   * @typedef {Object} Conversation
   * @property {string} timestamp
   * @property {string} userMessage
   * @property {string} reply
   * @property {string} sessionId
   * @property {string} [userEmail]
   * @property {{ id: string, title: string, tags?: string[] }[]} [contextEntries]
   */

  const API_URL_ENV = conversationsApiUrl;
  const API_URL = (() => {
    if (API_URL_ENV) {
      return API_URL_ENV;
    }
    if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      return "http://localhost:3000/api/conversations";
    }
    return "/api/conversations";
  })();

  let allConversations = [];
  let filteredConversations = [];

  // Elements
  const loadingState = document.getElementById("loadingState");
  const errorState = document.getElementById("errorState");
  const errorMessage = document.getElementById("errorMessage");
  const sessionsContainer = document.getElementById("sessionsContainer");
  const emptyState = document.getElementById("emptyState");
  const searchInput = document.getElementById("search");
  const dateFilter = document.getElementById("dateFilter");
  const refreshBtn = document.getElementById("refreshBtn");
  const totalCount = document.getElementById("totalCount");
  const todayCount = document.getElementById("todayCount");
  const avgLength = document.getElementById("avgLength");

  // Fetch conversations
  async function fetchConversations() {
    try {
      if (loadingState) loadingState.classList.remove("hidden");
      if (errorState) errorState.classList.add("hidden");
      if (sessionsContainer) sessionsContainer.classList.add("hidden");

      const response = await fetch(API_URL);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      allConversations = await response.json();
      filteredConversations = [...allConversations];

      updateStats();
      applyFilters();

      if (loadingState) loadingState.classList.add("hidden");
      if (sessionsContainer) sessionsContainer.classList.remove("hidden");
    } catch (error) {
      console.error("Fetch error:", error);
      if (loadingState) loadingState.classList.add("hidden");
      if (errorState) errorState.classList.remove("hidden");
      if (errorMessage) errorMessage.textContent = error instanceof Error ? error.message : String(error);
    }
  }

  // Update statistics
  function updateStats() {
    const total = allConversations.length;
    const today = new Date().toDateString();
    const todayConvos = allConversations.filter((c) => new Date(c.timestamp).toDateString() === today).length;
    const uniqueSessions = new Set(allConversations.map((c) => c.sessionId)).size;

    if (totalCount) totalCount.textContent = String(total);
    if (todayCount) todayCount.textContent = String(todayConvos);
    if (avgLength) avgLength.textContent = uniqueSessions + " klientÅ³";
  }

  // Apply filters
  function applyFilters() {
    const searchTerm = (searchInput && "value" in searchInput ? searchInput.value : "").toLowerCase();
    const dateFilterValue = dateFilter && "value" in dateFilter ? dateFilter.value : "all";

    filteredConversations = allConversations.filter((conv) => {
      const matchesSearch =
        conv.userMessage.toLowerCase().includes(searchTerm) ||
        conv.reply.toLowerCase().includes(searchTerm);

      const convDate = new Date(conv.timestamp);
      const now = new Date();
      let matchesDate = true;

      if (dateFilterValue === "today") {
        matchesDate = convDate.toDateString() === now.toDateString();
      } else if (dateFilterValue === "week") {
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        matchesDate = convDate >= weekAgo;
      } else if (dateFilterValue === "month") {
        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        matchesDate = convDate >= monthAgo;
      }

      return matchesSearch && matchesDate;
    });

    renderTable();
  }

  // Render sessions
  function renderTable() {
    const sessionGroups = {};

    filteredConversations.forEach((conv) => {
      const sid = conv.sessionId || "unknown";
      if (!sessionGroups[sid]) {
        sessionGroups[sid] = [];
      }
      sessionGroups[sid].push(conv);
    });

    if (Object.keys(sessionGroups).length === 0) {
      if (sessionsContainer) sessionsContainer.innerHTML = "";
      if (emptyState) emptyState.classList.remove("hidden");
      return;
    }

    if (emptyState) emptyState.classList.add("hidden");

    const sortedSessions = Object.entries(sessionGroups).sort((a, b) => {
      const aLatest = Math.max(...a[1].map((c) => new Date(c.timestamp).getTime()));
      const bLatest = Math.max(...b[1].map((c) => new Date(c.timestamp).getTime()));
      return bLatest - aLatest;
    });

    if (!sessionsContainer) return;

    sessionsContainer.innerHTML = sortedSessions
        .map(([sessionId, conversations]) => {
          const firstMsg = conversations[0];
          const lastMsg = conversations[conversations.length - 1];
          const firstDate = new Date(firstMsg.timestamp);
          const lastDate = new Date(lastMsg.timestamp);
          const userEmail = firstMsg.userEmail || "Nepateikta";

          const messagesHtml = conversations
            .map((conv) => {
              const date = new Date(conv.timestamp);
              const time = date.toLocaleTimeString("lt-LT", { hour: "2-digit", minute: "2-digit" });

              return `
            <div class="border-l-2 border-gray-200 pl-4 py-3 space-y-2">
              <div class="text-xs text-gray-500">${time}</div>
              
              <div class="bg-blue-50 rounded-lg p-3 border border-blue-100">
                <div class="text-xs font-medium text-blue-700 mb-1">ðŸ‘¤ Klausimas:</div>
                <div class="text-sm text-gray-800">${escapeHtml(conv.userMessage)}</div>
              </div>
              
              <div class="bg-green-50 rounded-lg p-3 border border-green-100">
                <div class="text-xs font-medium text-green-700 mb-1">ðŸ¤– Atsakymas:</div>
                <div class="text-sm text-gray-800 whitespace-pre-wrap">${escapeHtml(conv.reply)}</div>
              </div>
              
              ${conv.contextEntries && conv.contextEntries.length ? `
                <div class="text-xs text-gray-600">
                  ðŸ“š Kontekstas: ${conv.contextEntries.map((ctx) => ctx.title).join(", ")}
                </div>
              ` : ''}
            </div>
          `;
            })
            .join("");

          const shortId = sessionId.substring(sessionId.length - 8);

          return `
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 cursor-pointer hover:from-blue-600 hover:to-blue-700 transition-all"
                 onclick="toggleSession('${sessionId}')">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <span class="text-xl">ðŸ‘¤</span>
                  </div>
                  <div>
                    <div class="font-semibold">ðŸ“§ ${escapeHtml(userEmail)}</div>
                    <div class="text-xs opacity-90">Sesija: #${shortId} â€¢ ${conversations.length} Å¾inutÄ—(-s)</div>
                  </div>
                </div>
                <div class="text-right text-xs opacity-90">
                  <div>PradÄ—ta: ${firstDate.toLocaleString("lt-LT", { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" })}</div>
                  <div>PaskutinÄ—: ${lastDate.toLocaleString("lt-LT", { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" })}</div>
                </div>
                <div id="arrow-${sessionId}" class="transform transition-transform">â–¼</div>
              </div>
            </div>
            
            <div id="session-${sessionId}" class="hidden p-4 space-y-3 bg-gray-50">
              ${messagesHtml}
            </div>
          </div>
        `;
        })
        .join("");
  }

  // Toggle session visibility
  window.toggleSession = function toggleSession(sessionId) {
    const content = document.getElementById(`session-${sessionId}`);
    const arrow = document.getElementById(`arrow-${sessionId}`);

    if (content && content.classList.contains("hidden")) {
      content.classList.remove("hidden");
      if (arrow) arrow.style.transform = "rotate(180deg)";
    } else {
      if (content) content.classList.add("hidden");
      if (arrow) arrow.style.transform = "rotate(0deg)";
    }
  };

  // Escape HTML
  function escapeHtml(text) {
    const map = {
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#039;"
    };
    return text.replace(/[&<>"']/g, (m) => map[m] || m);
  }

  // Event listeners
  if (searchInput) searchInput.addEventListener("input", applyFilters);
  if (dateFilter) dateFilter.addEventListener("change", applyFilters);
  if (refreshBtn) refreshBtn.addEventListener("click", fetchConversations);

  // Initial load
  fetchConversations();

    // Auto-refresh every 30 seconds
    setInterval(fetchConversations, 30000);
  </script>

  <style>
    .line-clamp-4 {
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</MainLayout>
